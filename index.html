<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendamento de Aulas de Inglês</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.8s ease-in-out forwards; }
        .animate-fadeInUp { opacity: 0; animation: fadeInUp 0.6s ease-out forwards; }
        #confirmation-section { transition: all 0.5s ease-in-out; max-height: 0; overflow: hidden; }
        #confirmation-section.show { max-height: 500px; padding-top: 1.5rem; margin-top: 2rem; border-top-width: 1px; }
        .day.today { background-color: #dbeafe; font-weight: bold; }
        .day.selected { background-color: #3b82f6 !important; color: white !important; font-weight: bold; }
        .day:not(.disabled):hover { background-color: #eff6ff; }
        .day.disabled { color: #d1d5db; cursor: not-allowed; }
        .time-slot.selected { background-color: #3b82f6; color: white; border-color: #3b82f6; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Modal de Notificação -->
    <div id="notification-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-sm text-center animate-fadeInUp">
            <h3 id="notification-title" class="text-xl font-bold mb-2"></h3>
            <p id="notification-message" class="text-gray-600 mb-6"></p>
            <button id="notification-close-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors">
                Fechar
            </button>
        </div>
    </div>

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-10 animate-fadeInUp" style="animation-delay: 0.1s;">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Agende sua Aula de Inglês</h1>
            <p class="mt-2 text-lg text-gray-600">com o Professor <span id="teacher-name">[Seu Nome]</span></p>
        </header>

        <main class="max-w-4xl mx-auto bg-white p-6 sm:p-8 rounded-2xl shadow-lg animate-fadeInUp" style="animation-delay: 0.3s;">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="border-r-0 md:border-r border-gray-200 md:pr-8">
                    <h2 class="text-xl font-semibold mb-4">1. Escolha uma data</h2>
                    <div class="bg-gray-100 p-4 rounded-lg">
                        <div class="flex items-center justify-between mb-4">
                            <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                            </button>
                            <h3 id="month-year-header" class="font-semibold text-lg"></h3>
                            <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                            </button>
                        </div>
                        <div id="calendar-grid" class="grid grid-cols-7 gap-2 text-center text-sm">
                            <div class="font-medium text-gray-500">D</div><div class="font-medium text-gray-500">S</div><div class="font-medium text-gray-500">T</div><div class="font-medium text-gray-500">Q</div><div class="font-medium text-gray-500">Q</div><div class="font-medium text-gray-500">S</div><div class="font-medium text-gray-500">S</div>
                        </div>
                    </div>
                </div>

                <div>
                    <h2 class="text-xl font-semibold mb-4">2. Escolha um horário</h2>
                    <p id="selected-date-text" class="text-gray-600 mb-4">Selecione uma data para ver os horários</p>
                    <div id="available-times" class="max-h-80 overflow-y-auto pr-2 space-y-2">
                        <!-- Horários serão inseridos aqui -->
                    </div>
                </div>
            </div>

            <div id="confirmation-section" class="border-gray-200">
                <div class="animate-fadeInUp">
                    <h2 class="text-xl font-semibold mb-4">3. Confirme seus dados</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="name" class="block text-sm font-medium text-gray-700">Nome</label>
                            <input type="text" id="name" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="email" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                    </div>
                    <div class="mt-6 text-right">
                        <button id="confirm-btn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-all duration-200 shadow-md transform hover:scale-105">
                            Confirmar Agendamento
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <footer class="text-center mt-10 text-gray-500 text-sm animate-fadeIn" style="animation-delay: 0.5s;">
            <p>&copy; 2025 <span id="teacher-name-footer">[Seu Nome]</span> - Aulas de Inglês. Todos os direitos reservados.</p>
        </footer>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, addDoc, query, where, Timestamp, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURAÇÃO E INICIALIZAÇÃO ---
        const firebaseConfig = {
            apiKey: "AIzaSyDe3nn7CJkundWt0GESwDRXFzorbgUVXI8",
            authDomain: "escolainglessamara.firebaseapp.com",
            projectId: "escolainglessamara",
            storageBucket: "escolainglessamara.appspot.com",
            messagingSenderId: "806164689230",
            appId: "1:806164689230:web:ff9e1cd637fc0d1366ae1f"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        signInAnonymously(auth).catch((error) => {
            console.error("Erro na autenticação anônima:", error);
            showNotification("Erro de Conexão", "Não foi possível conectar ao sistema de agendamento. Por favor, tente novamente mais tarde.");
        });

        let currentDate = new Date();
        let selectedDate = null;
        let selectedTime = null;

        const monthYearHeader = document.getElementById('month-year-header');
        const calendarGrid = document.getElementById('calendar-grid');
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');
        const availableTimesContainer = document.getElementById('available-times');
        const selectedDateText = document.getElementById('selected-date-text');
        const confirmationSection = document.getElementById('confirmation-section');
        const confirmBtn = document.getElementById('confirm-btn');
        const nameInput = document.getElementById('name');
        const emailInput = document.getElementById('email');
        const notificationModal = document.getElementById('notification-modal');
        const notificationTitle = document.getElementById('notification-title');
        const notificationMessage = document.getElementById('notification-message');
        const notificationCloseBtn = document.getElementById('notification-close-btn');

        function showNotification(title, message) {
            notificationTitle.textContent = title;
            notificationMessage.textContent = message;
            notificationModal.classList.remove('hidden');
        }
        notificationCloseBtn.addEventListener('click', () => notificationModal.classList.add('hidden'));

        function formatDateToId(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        function renderCalendar() {
            calendarGrid.innerHTML = `<div class="font-medium text-gray-500">D</div><div class="font-medium text-gray-500">S</div><div class="font-medium text-gray-500">T</div><div class="font-medium text-gray-500">Q</div><div class="font-medium text-gray-500">Q</div><div class="font-medium text-gray-500">S</div><div class="font-medium text-gray-500">S</div>`;
            const month = currentDate.getMonth();
            const year = currentDate.getFullYear();
            monthYearHeader.textContent = `${currentDate.toLocaleString('pt-BR', { month: 'long' })} ${year}`;
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            for (let i = 0; i < firstDayOfMonth; i++) { calendarGrid.innerHTML += `<div></div>`; }
            for (let i = 1; i <= daysInMonth; i++) {
                const dayDate = new Date(year, month, i);
                const dayEl = document.createElement('div');
                dayEl.textContent = i;
                dayEl.classList.add('day', 'cursor-pointer', 'p-2', 'rounded-full', 'transition-colors');
                if (dayDate < today.setHours(0,0,0,0)) {
                    dayEl.classList.add('disabled');
                } else {
                    dayEl.addEventListener('click', () => selectDay(dayDate));
                }
                if (dayDate.toDateString() === today.toDateString()) { dayEl.classList.add('today'); }
                if (selectedDate && dayDate.toDateString() === selectedDate.toDateString()) { dayEl.classList.add('selected'); }
                calendarGrid.appendChild(dayEl);
            }
        }

        async function selectDay(date) {
            selectedDate = date;
            selectedTime = null;
            renderCalendar();
            confirmationSection.classList.remove('show');
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            selectedDateText.innerHTML = `Horários para <span class="font-bold text-blue-600">${date.toLocaleDateString('pt-BR', options)}</span>`;
            await renderAvailableTimes(date);
        }

        async function renderAvailableTimes(date) {
            availableTimesContainer.innerHTML = '<p class="text-gray-500">Carregando horários...</p>';
            
            const startOfDay = new Date(date);
            startOfDay.setHours(0, 0, 0, 0);
            const endOfDay = new Date(date);
            endOfDay.setHours(23, 59, 59, 999);

            try {
                // 1. Get existing appointments for the day
                const agendamentosRef = collection(db, "agendamentos");
                const q = query(agendamentosRef, where("timestamp", ">=", startOfDay), where("timestamp", "<=", endOfDay));
                const appointmentsSnapshot = await getDocs(q);
                const bookedTimes = appointmentsSnapshot.docs.map(doc => doc.data().timestamp.toDate().getHours());

                // 2. Get the specific unavailability rules for the day
                const docId = formatDateToId(date);
                const unavailRef = doc(db, "unavailable_slots", docId);
                const unavailSnap = await getDoc(unavailRef);
                const blockedHours = unavailSnap.exists() ? unavailSnap.data().blocked_hours || [] : [];

                availableTimesContainer.innerHTML = '';
                let hasAvailableSlots = false;
                for (let hour = 7; hour <= 21; hour++) {
                    const isBooked = bookedTimes.includes(hour);
                    const isBlockedByAdmin = blockedHours.includes(hour);
                    
                    const timeSlot = document.createElement('button');
                    timeSlot.classList.add('w-full', 'text-center', 'p-3', 'border', 'rounded-lg', 'transition-all', 'duration-200', 'ease-in-out', 'time-slot');
                    timeSlot.textContent = `${String(hour).padStart(2, '0')}:00 - ${String(hour + 1).padStart(2, '0')}:00`;

                    if(isBooked || isBlockedByAdmin) {
                        timeSlot.classList.add('border-gray-200', 'bg-gray-100', 'text-gray-400', 'cursor-not-allowed');
                        timeSlot.disabled = true;
                        if(isBooked) timeSlot.textContent += " (Agendado)";
                        if(isBlockedByAdmin) timeSlot.textContent += " (Indisponível)";
                    } else {
                        hasAvailableSlots = true;
                        timeSlot.classList.add('border-gray-300', 'hover:bg-blue-500', 'hover:text-white', 'hover:border-blue-500', 'transform', 'hover:scale-105');
                        timeSlot.addEventListener('click', () => selectTime(hour, timeSlot));
                    }
                    availableTimesContainer.appendChild(timeSlot);
                }
                
                if (!hasAvailableSlots) {
                     availableTimesContainer.innerHTML = '<p class="text-gray-500 text-center">Nenhum horário disponível para este dia.</p>';
                }

            } catch (error) {
                console.error("Erro ao buscar horários: ", error);
                availableTimesContainer.innerHTML = '<p class="text-red-500">Erro ao carregar horários. Tente novamente.</p>';
            }
        }

        function selectTime(hour, element) {
            selectedTime = hour;
            document.querySelectorAll('.time-slot').forEach(btn => btn.classList.remove('selected'));
            element.classList.add('selected');
            confirmationSection.classList.add('show');
        }

        async function handleConfirmation() {
            if (!selectedDate || selectedTime === null) {
                showNotification("Atenção", "Por favor, selecione uma data e um horário.");
                return;
            }
            const name = nameInput.value.trim();
            const email = emailInput.value.trim();
            if (!name || !email) {
                showNotification("Atenção", "Por favor, preencha seu nome e email.");
                return;
            }
            
            confirmBtn.disabled = true;
            confirmBtn.textContent = "Agendando...";

            const appointmentTimestamp = new Date(selectedDate);
            appointmentTimestamp.setHours(selectedTime, 0, 0, 0);

            try {
                await addDoc(collection(db, "agendamentos"), {
                    alunoNome: name,
                    alunoEmail: email,
                    timestamp: Timestamp.fromDate(appointmentTimestamp)
                });
                showNotification("Sucesso!", `Sua aula foi agendada para ${selectedDate.toLocaleDateString('pt-BR')} às ${selectedTime}:00.`);
                nameInput.value = '';
                emailInput.value = '';
                confirmationSection.classList.remove('show');
                selectDay(selectedDate); // Re-renderiza os horários do dia
            } catch (error) {
                console.error("Erro ao adicionar agendamento: ", error);
                showNotification("Erro", "Não foi possível completar o agendamento. Por favor, tente novamente.");
            } finally {
                confirmBtn.disabled = false;
                confirmBtn.textContent = "Confirmar Agendamento";
            }
        }

        prevMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
        nextMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });
        confirmBtn.addEventListener('click', handleConfirmation);
        
        window.onload = () => { renderCalendar(); };
    </script>
</body>
</html>
